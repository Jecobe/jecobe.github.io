<!doctype html>
<html>
<meta charset="utf-8">
<title>WebRTC Deep Check</title>
<pre id="log">Running…</pre>
<script>
(async () => {
  const out = (m) => log.textContent += m + "\n";
  const PC = window.RTCPeerConnection || window.webkitRTCPeerConnection || window.mozRTCPeerConnection;

  if (!PC) { out("❌ No RTCPeerConnection API — WebRTC not supported."); return; }
  out("✅ API present.");

  let pc;
  try {
    pc = new PC({iceServers: [{urls: "stun:stun.l.google.com:19302"}]});
    pc.createDataChannel("probe"); // permissionless
  } catch (e) {
    out("❌ Failed to construct RTCPeerConnection: " + e.name); return;
  }

  let gotAnyCandidate = false;
  let candidateTypes = new Set();

  pc.onicecandidate = (ev) => {
    if (ev.candidate) {
      gotAnyCandidate = true;
      // parse candidate type (host/srflx/relay)
      const m = ev.candidate.candidate.match(/ typ (\w+)/);
      if (m) candidateTypes.add(m[1]);
    }
  };

  pc.onicegatheringstatechange = () => {
    out("ICE gathering state: " + pc.iceGatheringState);
  };

  try {
    const offer = await pc.createOffer({offerToReceiveAudio: false, offerToReceiveVideo: false});
    await pc.setLocalDescription(offer);
    out("✅ Created offer + setLocalDescription.");

    // wait up to ~2s for candidates
    await new Promise(r => setTimeout(r, 2000));
    if (!gotAnyCandidate) {
      out("⚠️ No ICE candidates received. Likely: extension/policy blocking STUN/UDP or ICE.");
    } else {
      out("✅ Got ICE candidates. Types: " + [...candidateTypes].join(", "));
      if (!candidateTypes.size) out("(Could be mDNS host candidates, which hide real IPs.)");
    }

    // Check if gathering finished
    if (pc.iceGatheringState === "complete") {
      out("✅ ICE gathering completed.");
    } else {
      out("⚠️ ICE gathering not complete (possibly blocked or slow).");
    }
  } catch (e) {
    out("❌ Offer/SDP failed: " + e.name);
  } finally {
    try { pc.close(); } catch {}
  }

  out("\nNotes:\n- Extensions often block candidates (IP leak) but APIs remain, so 'WebRTC detected' is normal.\n- If you only want to hide IPs, mDNS/“anonymize local IPs” is enough.\n- If you want sites to *think WebRTC isn’t there*, you must disable it at the browser level (e.g., Firefox about:config -> media.peerconnection.enabled = false). Extensions generally can’t remove the API.");
})();
</script>
</html>
